extends layout.pug

block content
  .container
    // ASCII Art at the top
    .ascii-art
      pre
        |   ______                    _ ____     
        |  /_  __/__  _________ ___  (_) __/_  __
        |   / / / _ \/ ___/ __ `__ \/ / /_/ / / /
        |  / / /  __/ /  / / / / / / / __/ /_/ / 
        | /_/  \___/_/  /_/ /_/ /_/_/_/  \__, /  
        |                              /____/  

    .terminal
      p.command-line
        span #{user.id}@termify:~$
        input#command-input(type='text', placeholder='', autocomplete='off')

      .tracks-container
        each track, index in tracks
          .track.hidden
            span.track-number(data-number=`${(index + 1).toString().padStart(2, '0')}`)
            span.track-name(data-track=`${track.name}`)
            span.track-artist(data-artist=`${track.artists[0].name}`)

  script.
    document.addEventListener('DOMContentLoaded', () => {
      const commandInput = document.getElementById('command-input');
      const tracksContainer = document.querySelector('.tracks-container');
      let currentIndex = 0;

      // Automatically focus the input without clicking
      commandInput.focus();

      // Function to simulate typing effect for text
      function typeText(element, text, speed, callback) {
        let i = 0;
        function type() {
          if (i < text.length) {
            element.textContent += text.charAt(i);
            i++;
            setTimeout(type, speed); // Delay between each character
          } else {
            if (callback) callback(); // Call the callback after typing is done
          }
        }
        type();
      }

      // Function to display the next track, one by one
      function typeNextTrack(tracks) {
        currentIndex = 0; // Reset the index
        tracksContainer.innerHTML = ''; // Clear previous tracks

        function typeNext() {
          if (currentIndex < tracks.length) {
            const trackElement = document.createElement('div');
            trackElement.classList.add('track');

            const trackNumber = document.createElement('span');
            trackNumber.classList.add('track-number');
            const trackName = document.createElement('span');
            trackName.classList.add('track-name');
            const trackArtist = document.createElement('span');
            trackArtist.classList.add('track-artist');

            // Add elements to the track element
            trackElement.appendChild(trackNumber);
            trackElement.appendChild(trackName);
            trackElement.appendChild(trackArtist);
            tracksContainer.appendChild(trackElement);

            // Set the track number
            trackNumber.textContent = `${(currentIndex + 1).toString().padStart(2, '0')}`;

            const track = tracks[currentIndex];
            const nameText = ` ${track.name} - `;
            const artistText = track.artists[0].name;

            // First type out the track name, then the artist name
            typeText(trackName, nameText, 10, () => {
              typeText(trackArtist, artistText, 10, () => {
                currentIndex++;
                typeNext(); // Start typing the next track after this one finishes
              });
            });
          }
        }

        typeNext(); // Start typing the first track
      }

      // Fetch top tracks based on the time range
      async function fetchTopTracks(timeRange) {
        const response = await fetch(`/get-top-tracks?time_range=${timeRange}`);
        const data = await response.json();
        typeNextTrack(data.items); // Start typing out the fetched tracks
      }

      // Handle command input
      commandInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          const command = commandInput.value.trim().toLowerCase();

          if (command === '4weeks') {
            fetchTopTracks('short_term'); // Fetch tracks from past 4 weeks
          } else if (command === '6months') {
            fetchTopTracks('medium_term'); // Fetch tracks from past 6 months
          } else {
            alert('Invalid command. Try 4weeks or 6months.');
          }

          commandInput.value = ''; // Clear input after submission
        }
      });

      typeNextTrack([]); // Initially display an empty list
    });
